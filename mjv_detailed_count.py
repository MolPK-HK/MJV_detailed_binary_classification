# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12YlNMA5KDISq7uhnnYl8cxTqbre---Ur
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import os
import xgboost as xgb # ãƒ¢ãƒ‡ãƒ«æ¨è«–æ™‚ã«å¿…è¦

# --- å®šæ•°å®šç¾© (ãƒ¢ãƒ‡ãƒ«è¨“ç·´æ™‚ã¨åŒã˜ã‚‚ã®ã‚’ä½¿ç”¨) ---
MEDALS_PER_GAME_COST = 3
REPLAY_PROBABILITY = 1 / 7.3  # ãƒã‚¤ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼Vã®ä¸€èˆ¬çš„ãªãƒªãƒ—ãƒ¬ã‚¤ç¢ºç‡
PAYOUT_BIG_GROSS = 252      # BIGãƒœãƒ¼ãƒŠã‚¹1å›ã‚ãŸã‚Šã®ç·ç²å¾—æšæ•°
PAYOUT_REG_GROSS = 96       # REGãƒœãƒ¼ãƒŠã‚¹1å›ã‚ãŸã‚Šã®ç·ç²å¾—æšæ•°

def preprocess_inputs_for_10feature_model(input_data_dict):
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è¾æ›¸ï¼ˆ8ã¤ã®åŸºæœ¬æƒ…å ±ï¼‹å°å½¹ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã‹ã‚‰ã€
    ãƒ¢ãƒ‡ãƒ«äºˆæ¸¬ã«å¿…è¦ãª10å€‹ã®ç‰¹å¾´é‡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã€‚
    """
    df = pd.DataFrame([input_data_dict])

    # å¿…é ˆã‚­ãƒ¼ã®å­˜åœ¨ã¨å‹ãƒã‚§ãƒƒã‚¯
    required_keys_type = {
        'num_games_simulated': int,
        'sashimai': int,
        'solo_bb_count': int,
        'cherry_bb_count': int,
        'solo_rb_count': int,
        'cherry_rb_count': int,
        'grape_count': int,
        'cherry_count': int
    }
    for key, expected_type in required_keys_type.items():
        if key not in df.columns or pd.isna(df[key].iloc[0]):
            st.error(f"å…¥åŠ›ã‚¨ãƒ©ãƒ¼: '{key}' ã®å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            return None
        try:
            df[key] = df[key].astype(expected_type)
        except ValueError:
            st.error(f"å…¥åŠ›ã‚¨ãƒ©ãƒ¼: '{key}' ã®å€¤ãŒä¸æ­£ã§ã™ã€‚é©åˆ‡ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            return None
        if key == 'num_games_simulated' and df[key].iloc[0] <= 0:
            st.error(f"å…¥åŠ›ã‚¨ãƒ©ãƒ¼: 'num_games_simulated' ã¯æ­£ã®æ•´æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚")
            return None

    # --- 10å€‹ã®åŸºæœ¬ç‰¹å¾´é‡ã®è¨ˆç®— ---
    df['num_games'] = df['num_games_simulated']

    # estimated_total_medals_in ã¨ calculated_total_medals_out ã®è¨ˆç®—
    df['estimated_total_medals_in'] = df['num_games'] * (1 - REPLAY_PROBABILITY) * MEDALS_PER_GAME_COST
    df['estimated_total_medals_in'] = np.where(df['num_games'] > 0, df['estimated_total_medals_in'], 0).clip(min=0)
    df['calculated_total_medals_out'] = df['sashimai'] + df['estimated_total_medals_in']

    # å„ç¨®ãƒ¬ãƒ¼ãƒˆã®è¨ˆç®—
    total_bb_count = df['solo_bb_count'] + df['cherry_bb_count']
    df['bb_rate'] = np.where(df['num_games'] > 0, total_bb_count / df['num_games'], 0)
    total_rb_count = df['solo_rb_count'] + df['cherry_rb_count']
    df['rb_rate'] = np.where(df['num_games'] > 0, total_rb_count / df['num_games'], 0)

    df['machine_percentage_rpm'] = np.where(
        df['estimated_total_medals_in'] > 0,
        df['calculated_total_medals_out'] / df['estimated_total_medals_in'], 1.0
    )
    df['grape_rate'] = np.where(df['num_games'] > 0, df['grape_count'] / df['num_games'], 0)
    df['cherry_rate'] = np.where(df['num_games'] > 0, df['cherry_count'] / df['num_games'], 0) # ç·ãƒã‚§ãƒªãƒ¼å›æ•°ã‚’ä½¿ç”¨
    df['solo_bb_rate'] = np.where(df['num_games'] > 0, df['solo_bb_count'] / df['num_games'], 0)
    df['solo_rb_rate'] = np.where(df['num_games'] > 0, df['solo_rb_count'] / df['num_games'], 0)
    df['cherry_bb_rate'] = np.where(df['num_games'] > 0, df['cherry_bb_count'] / df['num_games'], 0)
    df['cherry_rb_rate'] = np.where(df['num_games'] > 0, df['cherry_rb_count'] / df['num_games'], 0)

    # ãƒ¢ãƒ‡ãƒ«ãŒä½¿ç”¨ã™ã‚‹ç‰¹å¾´é‡ã®ãƒªã‚¹ãƒˆ (è¨“ç·´æ™‚ã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã‚‹)
    feature_columns = [
        'num_games', 'bb_rate', 'rb_rate', 'machine_percentage_rpm',
        'grape_rate', 'cherry_rate',
        'solo_bb_rate', 'solo_rb_rate', 'cherry_bb_rate', 'cherry_rb_rate'
    ]

    # NaN/infå‡¦ç†
    for col in feature_columns:
        if col in df.columns:
             df[col] = df[col].replace([np.inf, -np.inf], np.nan).fillna(0)
        else:
            st.error(f"ã‚¨ãƒ©ãƒ¼: ç‰¹å¾´é‡ '{col}' ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…¥åŠ›ã‚­ãƒ¼ã‚„è¨ˆç®—éç¨‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
            return None

    X_transformed = df[feature_columns]
    return X_transformed

# ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
@st.cache_resource # Streamlit 1.19.0 ä»¥é™ã§ã¯ _resource, ãã‚Œä»¥å‰ã¯ _singleton ã‚„ _rerun
def load_model(model_path):
    if not os.path.exists(model_path):
        st.error(f"ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« '{model_path}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return None
    try:
        model = joblib.load(model_path)
        st.success(f"ãƒ¢ãƒ‡ãƒ« '{model_path}' ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚")
        return model
    except Exception as e:
        st.error(f"ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

# --- Streamlit ã‚¢ãƒ—ãƒªã®UIéƒ¨åˆ† ---
st.set_page_config(page_title="è¨­å®šåˆ¤åˆ¥ã‚¢ãƒ—ãƒª (è©³ç´°å…¥åŠ›ç‰ˆ)", layout="wide")
st.title("ãƒã‚¤ã‚¸ãƒ£ã‚°ãƒ©ãƒ¼V è¨­å®šåˆ¤åˆ¥ã‚¢ãƒ—ãƒª (è©³ç´°å…¥åŠ›ãƒ»2å€¤åˆ†é¡)")
st.markdown("å…¥åŠ›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€è¨­å®šãŒã€Œä½ä¸­è¨­å®š(1-3)ã€ã‹ã€Œé«˜ä¸­è¨­å®š(4-6)ã€ã‹ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚")

# â˜…â˜…â˜… å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š â˜…â˜…â˜…
MODEL_FILE_PATH = 'juggler_binary_classifier_grape_tuned.joblib' # 10ç‰¹å¾´é‡ã§è¨“ç·´ãƒ»ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸãƒ¢ãƒ‡ãƒ«

trained_model = load_model(MODEL_FILE_PATH)

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹
st.sidebar.header("éŠæŠ€ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
num_games_input = st.sidebar.number_input("ç·ã‚²ãƒ¼ãƒ æ•°", min_value=1, value=3000, step=100, key="num_games_detailed")
sashimai_input = st.sidebar.number_input("å·®æš (ä¾‹: +1000, -500)", value=0, step=50, key="sashimai_detailed")
solo_bb_count_input = st.sidebar.number_input("å˜ç‹¬BIGå›æ•°", min_value=0, value=8, step=1, key="solo_bb_detailed")
cherry_bb_count_input = st.sidebar.number_input("ãƒã‚§ãƒªãƒ¼é‡è¤‡BIGå›æ•°", min_value=0, value=2, step=1, key="cherry_bb_detailed")
solo_rb_count_input = st.sidebar.number_input("å˜ç‹¬REGå›æ•°", min_value=0, value=7, step=1, key="solo_rb_detailed")
cherry_rb_count_input = st.sidebar.number_input("ãƒã‚§ãƒªãƒ¼é‡è¤‡REGå›æ•°", min_value=0, value=3, step=1, key="cherry_rb_detailed")
grape_count_input = st.sidebar.number_input("ãƒ–ãƒ‰ã‚¦å›æ•°", min_value=0, value=500, step=10, key="grape_detailed")
cherry_count_input = st.sidebar.number_input("ç·ãƒã‚§ãƒªãƒ¼å›æ•° (ãƒœãƒ¼ãƒŠã‚¹é‡è¤‡å«ã‚€)", min_value=0, value=80, step=5, key="cherry_total_detailed")


# äºˆæ¸¬ãƒœã‚¿ãƒ³
if st.sidebar.button("è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã‚’åˆ¤åˆ¥ã™ã‚‹ (è©³ç´°å…¥åŠ›)", type="primary", key="predict_button_detailed"):
    if trained_model is not None:
        # preprocessé–¢æ•°ãŒæœŸå¾…ã™ã‚‹ã‚­ãƒ¼åã«åˆã‚ã›ã‚‹
        user_inputs_dict = {
            'num_games_simulated': num_games_input,
            'sashimai': sashimai_input,
            'solo_bb_count': solo_bb_count_input,
            'cherry_bb_count': cherry_bb_count_input,
            'solo_rb_count': solo_rb_count_input,
            'cherry_rb_count': cherry_rb_count_input,
            'grape_count': grape_count_input,
            'cherry_count': cherry_count_input
        }

        st.markdown("---")
        st.subheader("å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ (è©³ç´°):")
        # è¡¨ç¤ºç”¨ã«æ•´å½¢
        display_inputs = {
            "ç·ã‚²ãƒ¼ãƒ æ•°": user_inputs_dict['num_games_simulated'],
            "å·®æš": user_inputs_dict['sashimai'],
            "å˜ç‹¬BIG": user_inputs_dict['solo_bb_count'],
            "ãƒã‚§ãƒªãƒ¼é‡è¤‡BIG": user_inputs_dict['cherry_bb_count'],
            "å˜ç‹¬REG": user_inputs_dict['solo_rb_count'],
            "ãƒã‚§ãƒªãƒ¼é‡è¤‡REG": user_inputs_dict['cherry_rb_count'],
            "ãƒ–ãƒ‰ã‚¦å›æ•°": user_inputs_dict['grape_count'],
            "ç·ãƒã‚§ãƒªãƒ¼å›æ•°": user_inputs_dict['cherry_count'],
        }
        st.json(display_inputs)

        # ç‰¹å¾´é‡ã¸å¤‰æ›
        features_for_prediction = preprocess_inputs_for_10feature_model(user_inputs_dict)

        if features_for_prediction is not None:
            st.subheader("è¨ˆç®—ã•ã‚ŒãŸç‰¹å¾´é‡ (ãƒ¢ãƒ‡ãƒ«å…¥åŠ›ç”¨):")
            st.dataframe(features_for_prediction)

            try:
                # äºˆæ¸¬ã®å®Ÿè¡Œ
                prediction_label_encoded = trained_model.predict(features_for_prediction)[0]
                predicted_probabilities = trained_model.predict_proba(features_for_prediction)[0]

                class_names = ['è¨­å®š1-3ã‚°ãƒ«ãƒ¼ãƒ— (ä½ä¸­è¨­å®š)', 'è¨­å®š4-6ã‚°ãƒ«ãƒ¼ãƒ— (é«˜ä¸­è¨­å®š)']
                predicted_class_name = class_names[prediction_label_encoded]

                st.subheader("ğŸ“ˆ äºˆæ¸¬çµæœ")
                st.markdown(f"**åˆ¤åˆ¥ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—:** <span style='font-size:1.5em; color:blue;'>{predicted_class_name}</span>", unsafe_allow_html=True)

                col1, col2 = st.columns(2)
                with col1:
                    st.metric(label=f"'{class_names[0]}' ã§ã‚ã‚‹ç¢ºç‡", value=f"{predicted_probabilities[0]:.2%}")
                with col2:
                    st.metric(label=f"'{class_names[1]}' ã§ã‚ã‚‹ç¢ºç‡", value=f"{predicted_probabilities[1]:.2%}")

                # ç¢ºç‡ã«åŸºã¥ã„ãŸç°¡æ˜“çš„ãªã‚³ãƒ¡ãƒ³ãƒˆ
                if predicted_probabilities[1] > 0.80: # é«˜ä¸­è¨­å®šã§ã‚ã‚‹ç¢ºç‡ãŒ80%è¶…
                    st.success("é«˜ä¸­è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã®å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚")
                elif predicted_probabilities[1] > 0.65: # é«˜ä¸­è¨­å®šã§ã‚ã‚‹ç¢ºç‡ãŒ65%è¶…
                    st.info("é«˜ä¸­è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã®å¯èƒ½æ€§ãŒé«˜ã„ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚")
                elif predicted_probabilities[0] > 0.80: # ä½ä¸­è¨­å®šã§ã‚ã‚‹ç¢ºç‡ãŒ80%è¶…
                    st.success("ä½ä¸­è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã®å¯èƒ½æ€§ãŒéå¸¸ã«é«˜ã„ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚")
                elif predicted_probabilities[0] > 0.65: # ä½ä¸­è¨­å®šã§ã‚ã‚‹ç¢ºç‡ãŒ65%è¶…
                    st.info("ä½ä¸­è¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã®å¯èƒ½æ€§ãŒé«˜ã„ã¨æ¨æ¸¬ã•ã‚Œã¾ã™ã€‚")
                else:
                    st.warning("äºˆæ¸¬ã®ç¢ºä¿¡åº¦ã¯ä¸­é–“çš„ã§ã™ã€‚ã‚ˆã‚Šå¤šãã®ã‚²ãƒ¼ãƒ æ•°ã§å†åº¦ã”ç¢ºèªãã ã•ã„ã€‚")

            except Exception as e:
                st.error(f"äºˆæ¸¬ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                import traceback
                st.text(traceback.format_exc())
        else:
            st.error("ç‰¹å¾´é‡ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    else:
        st.error("ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šè¨˜ã®ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã€Streamlitã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚")

st.sidebar.markdown("---")
st.sidebar.markdown("ã“ã®ã‚¢ãƒ—ãƒªã¯æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹äºˆæ¸¬ã§ã‚ã‚Šã€å®Ÿéš›ã®è¨­å®šã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")